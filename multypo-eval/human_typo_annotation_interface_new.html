<!-- annotator.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Typo Annotation Task</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 40px; max-width: 800px; }
    .highlight { background-color: #ffcdd2; font-weight: bold; }
    .hidden { display: none; }
    .sentence { font-size: 18px; margin-bottom: 20px; }
    .btn { padding: 10px 20px; font-size: 16px; margin: 10px 5px; cursor: pointer; }
    .btn:disabled { opacity: 0.5; }
    .selected { background-color: #1976d2; color: white; }
    #annotation-box { margin-top: 30px; padding: 20px; border: 1px solid #ccc; }
  </style>
</head>
<body>
<h2>Multilingual Typo Evaluation</h2>
<p>This annotation task will show you sentences that contain typographical errors. Your job is to judge whether the typos look <strong>natural</strong> or <strong>unnatural</strong>.</p>
<p>Please select your language and begin the task. There are 60 sentences in total per language.</p>
<label for="language-select">Select Language:</label>
<select id="language-select">
  <option value="">-- Choose --</option>
  <option value="en">English</option>
  <option value="de">German</option>
  <option value="fr">French</option>
  <option value="el">Greek</option>
  <option value="ru">Russian</option>
  <option value="ar">Arabic</option>
  <option value="hi">Hindi</option>
</select>
<button class="btn" onclick="startAnnotation()">Start Annotation</button>

<div id="annotation-box" class="hidden">
  <p><strong>Progress:</strong> <span id="progress">0 / 60</span></p>
  <div class="sentence" id="sentence-text"></div>
  <div>
    <button class="btn" id="btn-natural" onclick="selectJudgment('Natural')">Looks Natural</button>
    <button class="btn" id="btn-unnatural" onclick="selectJudgment('Unnatural')">Looks Unnatural</button>
  </div>
  <div>
    <button class="btn" onclick="prevQuestion()">Back</button>
    <button class="btn" onclick="nextQuestion()">Next</button>
    <button class="btn" onclick="submitAll()">Submit All</button>
  </div>
</div>

<script>
let data = [];
let currentIndex = 0;
let results = [];
let selectedLang = "";
let annotId = "";

function startAnnotation() {
  selectedLang = document.getElementById("language-select").value;
  if (!selectedLang) return alert("Please select a language.");

  fetch(`annot_eval_${selectedLang}_typo.csv`)
    .then(res => res.text())
    .then(csv => {
      data = parseCSV(csv);
      currentIndex = 0;
      results = Array(data.length).fill(null);
      annotId = `${Date.now()}_${Math.floor(Math.random()*10000)}`;
      document.getElementById("annotation-box").classList.remove("hidden");
      renderQuestion();
    });
}

function parseCSV(csv) {
  const [headerLine, ...lines] = csv.trim().split("\n");
  const headers = headerLine.split(",");
  return lines.map(line => {
    const values = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
    const row = {};
    headers.forEach((h, i) => {
      row[h.trim()] = values[i]?.trim()?.replace(/^"|"$/g, "").replace(/""/g, '"');
    });
    return row;
  });
}

function renderHighlighted(text) {
  return text.replace(/\*\*(.+?)\*\*/g, '<span class="highlight">$1</span>');
}

function renderQuestion() {
  if (currentIndex < 0) currentIndex = 0;
  if (currentIndex >= data.length) return;
  const item = data[currentIndex];
  document.getElementById("sentence-text").innerHTML = renderHighlighted(item.highlighted);
  document.getElementById("progress").textContent = `${currentIndex + 1} / ${data.length}`;
  highlightSelected();
}

function highlightSelected() {
  document.getElementById("btn-natural").classList.remove("selected");
  document.getElementById("btn-unnatural").classList.remove("selected");
  const current = results[currentIndex];
  if (current === "Natural") document.getElementById("btn-natural").classList.add("selected");
  if (current === "Unnatural") document.getElementById("btn-unnatural").classList.add("selected");
}

function selectJudgment(judgment) {
  results[currentIndex] = judgment;
  highlightSelected();
}

function prevQuestion() {
  if (currentIndex > 0) currentIndex--;
  renderQuestion();
}

function nextQuestion() {
  if (!results[currentIndex]) return alert("Please select a judgment first.");
  if (currentIndex < data.length - 1) currentIndex++;
  renderQuestion();
}

function submitAll() {
  if (results.includes(null)) return alert("Please annotate all sentences before submitting.");
  const submission = data.map((item, i) => ({
    index: item.orig_index,
    clean: item.clean,
    corrupted: item.corrupted,
    highlighted: item.highlighted,
    source: item.source,
    judgment: results[i]
  }));
  fetch("http://<your-server-ip>:8080/submit", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ language: selectedLang, responses: submission })
  }).then(() => {
    alert("✅ Submission complete! Thank you.");
    location.reload();
  }).catch(() => alert("❌ Failed to save. Try again later."));
}
</script>
</body>
</html>
